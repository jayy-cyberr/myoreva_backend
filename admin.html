<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyOreva - Admin Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #169946;
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation Tabs */
        .navigation-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            gap: 20px;
        }

        .nav-tab {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px 25px;
            border: none;
            background: rgba(7, 56, 41, 0.1);
            color: #073829;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            min-width: 200px;
            justify-content: center;
        }

        .nav-tab:hover {
            background: rgba(22, 153, 70, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(22, 153, 70, 0.2);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #169946, #073829);
            color: white;
            box-shadow: 0 5px 15px rgba(22, 153, 70, 0.4);
        }

        .nav-tab i {
            font-size: 1.2rem;
        }

        /* Section containers */
        .section-container {
            display: none;
        }
        .moves{
            margin-bottom: 6rem;
        }

        .section-container.active {
            display: block;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #073829;
            font-size: 2rem;
            font-weight: 700;
        }

        .header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #169946, #073829);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .stat-card .icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.8;
        }

        .stat-card.total .icon { color: #169946; }
        .stat-card.revenue .icon { color: #073829; }
        .stat-card.pending .icon { color: #ed8936; }
        .stat-card.delivered .icon { color: #169946; }
        .stat-card.newsletter .icon { color: #073829; }

        .stat-card h3 {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #073829;
        }

        .stat-card p {
            color: #718096;
            font-size: 1rem;
            font-weight: 500;
        }

        .dashboard-content {
            margin-bottom: 30px;
        }

        .orders-section,
        .newsletter-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 30px;
        }

        .section-header {
            background: linear-gradient(135deg, #169946, #073829);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .filters {
            padding: 20px 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #073829;
        }

        .filter-group input,
        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #169946;
            box-shadow: 0 0 0 3px rgba(22, 153, 70, 0.1);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #169946, #073829);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(22, 153, 70, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #073829;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-success {
            background: #169946;
            color: white;
        }

        .btn-success:hover {
            background: #0f7a35;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(22, 153, 70, 0.4);
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .orders-table,
        .subscribers-table {
            width: 100%;
            border-collapse: collapse;
        }

        .orders-table th,
        .orders-table td,
        .subscribers-table th,
        .subscribers-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .orders-table th,
        .subscribers-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #073829;
            position: sticky;
            top: 0;
        }

        .orders-table tr:hover,
        .subscribers-table tr:hover {
            background: #f8fafc;
        }

        .subscribers-table {
            margin-top: 20px;
        }

        .subscribers-table th,
        .subscribers-table td {
            padding: 12px 15px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fed7d7;
            color: #c53030;
        }

        .status-processing {
            background: #feebc8;
            color: #dd6b20;
        }

        .status-delivered {
            background: rgba(22, 153, 70, 0.1);
            color: #169946;
        }

        .status-cancelled {
            background: #e2e8f0;
            color: #4a5568;
        }

        .status-basic {
            background: rgba(22, 153, 70, 0.1);
            color: #169946;
        }

        .status-standard {
            background: rgba(7, 56, 41, 0.1);
            color: #073829;
        }

        .status-premium {
            background: rgba(237, 137, 54, 0.1);
            color: #ed8936;
        }

        .status-deluxe {
            background: rgba(245, 101, 101, 0.1);
            color: #f56565;
        }

        .newsletter-form {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #073829;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #169946;
            box-shadow: 0 0 0 3px rgba(22, 153, 70, 0.1);
        }

        .image-upload {
            position: relative;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .image-upload:hover {
            border-color: #169946;
            background: #f8fafc;
        }

        .image-upload.has-image {
            border-style: solid;
            border-color: #169946;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .template-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .template-option {
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .template-option:hover {
            border-color: #169946;
            box-shadow: 0 2px 8px rgba(22, 153, 70, 0.1);
        }

        .template-option.selected {
            border-color: #169946;
            background: rgba(22, 153, 70, 0.05);
        }

        .template-option h4 {
            margin: 0 0 5px 0;
            color: #073829;
            font-size: 14px;
        }

        .template-option p {
            margin: 0;
            color: #718096;
            font-size: 12px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-top: 30px; 
        }

        .chart-content {
            padding: 20px;
            height: 400px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .preview-modal .modal-content {
            max-width: 800px;
        }

        .modal-header {
            background: linear-gradient(135deg, #169946, #073829);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .preview-modal .modal-body {
            padding: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .order-detail {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .order-detail .detail-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #169946;
        }

        .order-detail .detail-item strong {
            display: block;
            color: #073829;
            margin-bottom: 5px;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pagination {
            padding: 20px 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: #f8fafc;
        }

        .pagination button {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover:not(:disabled) {
            background: #169946;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current {
            background: #169946;
            color: white;
            border-color: #169946;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .loading i {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #718096;
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .preview-frame {
            width: 100%;
            height: 600px;
            border: none;
            border-radius: 8px;
            background: white;
        }

        /* Footer Navigation */
        .footer-nav {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1400px;
            margin-top: 10em;
        }

        .footer-nav .btn {
            min-width: 150px;
            justify-content: center;
        }

        /* Add this CSS to your existing styles */
        .status-cell {
            text-align: center;
        }
        .status-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .status-pending {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .status-pending:hover {
            background: #fed7d7 !important;
            transform: scale(1.05);
        }

        .processing-steps {
            background: #667eea;
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 12px;
            margin: 0;
            min-width: fit-content;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .processing-step-item {
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #169946;
        }

        .processing-step-item strong {
            color: #073829;
            display: block;
            margin-bottom: 2px;
        }

        .processing-step-item span {
            color: #666;
            font-size: 0.85rem;
        }

        .processing-codes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
            margin: 15px 0;
        }

        .code-option {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
        }

        .code-option:hover {
            border-color: #169946;
            background: #f0fff4;
        }

        .code-option.selected {
            border-color: #169946;
            background: #169946;
            color: white;
        }

        .code-option .code {
            font-weight: bold;
            display: block;
        }

        .code-option .desc {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .navigation-tabs {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-tab {
                min-width: auto;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
            
            .export-buttons {
                flex-direction: column;
            }

            .orders-table,
            .subscribers-table {
                font-size: 0.875rem;
            }

            .orders-table th,
            .orders-table td,
            .subscribers-table th,
            .subscribers-table td {
                padding: 10px 8px;
            }

            .newsletter-form > div {
                grid-template-columns: 1fr !important;
            }

            .footer-nav {
                flex-direction: column;
                width: 100%;
                bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-tachometer-alt"></i> MyOreva Admin Dashboard</h1>
            <div class="user-info">
                <span><i class="fas fa-user-circle"></i> Admin</span>
                <span id="lastUpdated" style="margin-right: 10px;">Last updated: -</span>
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportToExcel()">
                        <i class="fas fa-file-excel"></i> Excel
                    </button>
                    <button class="btn btn-secondary" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                </div>
            </div>
        </div>

        <!-- HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHDDDDDDDDDDDDDDDDDDDDDDDD -->
        <!-- Dashboard Section -->
        <div class="section-container active" id="dashboard-section">
            <div class="stats-grid">
                <div class="stat-card total">
                    <i class="fas fa-shopping-cart icon"></i>
                    <h3 id="totalOrders">-</h3>
                    <p>Total Orders</p>
                </div>
                <div class="stat-card revenue">
                    <i class="fas fa-money-bill-wave icon"></i>
                    <h3 id="totalRevenue">₦-</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card pending">
                    <i class="fas fa-clock icon"></i>
                    <h3 id="pendingOrders">-</h3>
                    <p>Pending Orders</p>
                </div>
                <div class="stat-card delivered">
                    <i class="fas fa-check-circle icon"></i>
                    <h3 id="deliveredOrders">-</h3>
                    <p>Delivered Orders</p>
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div class="section-container moves" id="orders-section">
            <div class="orders-section">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> Orders Management</h2>
                    <span id="orderCount">0 orders</span>
                </div>

                <!-- Filters -->
                <div class="filters">
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="searchInput" placeholder="Name, phone, address...">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="statusFilter">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Package</label>
                        <select id="packageFilter">
                            <option value="all">All Packages</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>From Date</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="filter-group">
                        <label>To Date</label>
                        <input type="date" id="endDate">
                    </div>
                    <div class="filter-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-filter"></i> Apply Filters
                        </button>
                    </div>
                </div>

                <!-- Loading -->
                <div class="loading" id="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading orders...</p>
                </div>

                <!-- Orders Table -->
                <div style="overflow-x: auto;">
                    <table class="orders-table" id="ordersTable">
                        <thead>
                            <tr>
                                <th>Full Name</th>
                                <th>Phone</th>
                                <th>Package</th>
                                <th>Address</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="no-data" id="noData" style="display: none;">
                    <i class="fas fa-inbox"></i>
                    <h3>No orders found</h3>
                    <p>Try adjusting your filters or check back later.</p>
                </div>

                <div class="pagination" id="pagination">
                </div>
            </div>
        </div>

        <!-- Package Analytics Section -->
        <div class="section-container moves" id="analytics-section">
            <div class="chart-container">
                <div class="section-header">
                    <h2><i class="fas fa-chart-pie"></i> Package Analytics</h2>
                </div>
                <div class="chart-content">
                    <canvas id="packageChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Newsletter Management Section -->
        <div class="section-container moves" id="newsletter-section">
            <div class="newsletter-section">
                <div class="section-header">
                    <h2><i class="fas fa-paper-plane"></i> Newsletter Management</h2>
                    <button class="btn btn-secondary" onclick="toggleNewsletterSection()">
                        <i class="fas fa-users"></i> <span id="subscriberCount">0 Subscribers</span>
                    </button>
                </div>

                <div class="newsletter-form" id="newsletterForm">
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
                        <!-- Left Column -->
                        <div>
                            <div class="form-group">
                                <label>Subject</label>
                                <input type="text" id="newsletterSubject" placeholder="Enter email subject...">
                            </div>
                            <div class="form-group">
                                <label>Message</label>
                                <div id="newsletterMessageEditor" style="min-height: 120px; background: white; border: 2px solid #e2e8f0; border-radius: 8px;"></div>
                            </div>
                            <div class="form-group">
                                <label>Newsletter Image URL (Optional)</label>
                                <input type="text" id="newsletterImageUrl" placeholder="Enter image URL" oninput="handleImageUrlInput(this.value)">
                                <div id="imagePreview" style="margin-top: 10px; text-align: center;">
                                    <img id="previewImage" style="max-width: 100%; max-height: 200px; border-radius: 8px; display: none;" alt="Image Preview">
                                    <br>
                                    <p id="previewMessage" style="margin: 0; color: #48bb78; font-weight: 600; display: none;">Image URL loaded successfully</p>
                                    <p id="previewError" style="margin: 0; color: #f56565; font-weight: 600; display: none;">Invalid image URL</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div>
                            <div class="form-group">
                                <label>Email Template</label>
                                <div class="template-selector" id="templateSelector">
                                    <!-- Templates will be loaded here -->
                                </div>
                            </div>
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button class="btn btn-secondary" onclick="previewNewsletter()" style="width: 100%; margin-bottom: 10px;">
                                    <i class="fas fa-eye"></i> Preview Newsletter
                                </button>
                                <button class="btn btn-primary" onclick="sendNewsletter()" style="width: 100%;">
                                    <i class="fas fa-paper-plane"></i> Send Newsletter
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subscribers List -->
                <div id="subscribersList" style="display: none;">
                    <div style="padding: 20px 30px; background: #f8fafc; border-top: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #2d3748;">Subscribers List</h3>
                            <button class="btn btn-secondary" onclick="refreshSubscribers()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                        
                        <div style="overflow-x: auto;">
                            <table class="subscribers-table">
                                <thead>
                                    <tr>
                                        <th>Email</th>
                                        <th>Subscribed Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="subscribersTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer Navigation -->
        <div class="footer-nav">
            <button class="btn btn-primary active" onclick="showSection('dashboard-section')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="btn btn-primary" onclick="showSection('orders-section')">
                <i class="fas fa-list"></i> Orders
            </button>
            <button class="btn btn-primary" onclick="showSection('analytics-section')">
                <i class="fas fa-chart-pie"></i> Analytics
            </button>
            <button class="btn btn-primary" onclick="showSection('newsletter-section')">
                <i class="fas fa-paper-plane"></i> Newsletter
            </button>
        </div>

        <!-- Order Details Modal -->
        <div id="orderModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-eye"></i> Order Details</h2>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
                <div class="modal-body" id="orderDetails">
                </div>
            </div>
        </div>

        <!-- Status Update Modal -->
        <div id="statusModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-edit"></i> Update Order Status</h2>
                    <span class="close" onclick="closeStatusModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="filter-group">
                        <label>Select New Status</label>
                        <select id="newStatus" style="width: 100%; padding: 12px;">
                            <option value="processing">Processing</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="closeStatusModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updateOrderStatus()" style="margin-left: 10px;">
                            <i class="fas fa-save"></i> Update Status
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Newsletter Preview Modal -->
        <div id="previewModal" class="modal preview-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-eye"></i> Newsletter Preview</h2>
                    <span class="close" onclick="closePreviewModal()">&times;</span>
                </div>
                <div class="modal-body" style="padding: 0;">
                    <iframe id="previewFrame" class="preview-frame"></iframe>
                </div>
            </div>
        </div>

        <!-- Processing Steps Modal -->
        <div id="processingStepsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-tasks"></i> Processing Steps</h2>
                    <span class="close" onclick="closeProcessingStepsModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div id="existingSteps">
                        <h4>Current Steps:</h4>
                        <div id="stepsList"></div>
                    </div>
                    
                    <div style="margin: 20px 0; border-top: 1px solid #e2e8f0; padding-top: 20px;">
                        <h4>Add New Step:</h4>
                        <div class="processing-codes-grid" id="processingCodes">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="closeProcessingStepsModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="addProcessingStep()" style="margin-left: 10px;" id="addStepBtn" disabled>
                            <i class="fas fa-plus"></i> Add Step
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Package/Price Update Modal -->
        <div id="packagePriceModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-tag"></i> Update Package & Price</h2>
                    <span class="close" onclick="closePackagePriceModal()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Package Name</label>
                        <input type="text" id="newPackage" placeholder="Enter package name" style="width: 100%; padding: 12px;">
                    </div>
                    <div class="form-group">
                        <label>Price (₦)</label>
                        <input type="number" id="newPrice" placeholder="Enter new price" style="width: 100%; padding: 12px;" min="1">
                    </div>
                    <div style="margin-top: 20px; text-align: right;">
                        <button class="btn btn-secondary" onclick="closePackagePriceModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="updatePackagePrice()" style="margin-left: 10px;">
                            <i class="fas fa-save"></i> Update
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
        let autoRefreshInterval = null;

        function refreshDashboardData() {
            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
            loadStats();
            loadOrders(currentPage);
            loadSubscriberCount();
        }

        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            autoRefreshInterval = setInterval(() => {
                const modals = document.querySelectorAll('.modal');
                const isModalOpen = Array.from(modals).some(modal => modal.style.display === 'block');
                if (!isModalOpen) {
                    refreshDashboardData();
                }
            }, 300000);
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }

        let currentPage = 1;
        let currentOrderId = null;
        let packageChart = null;
        let quill = null;
        let selectedTemplate = 'modern';
        let newsletterImage = null;

        // Function to show specific section and update button states
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section-container').forEach(section => {
                section.classList.remove('active');
            });

            // Deactivate all footer buttons
            document.querySelectorAll('.footer-nav .btn').forEach(button => {
                button.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Activate corresponding button
            const activeButton = document.querySelector(`.footer-nav .btn[onclick="showSection('${sectionId}')"]`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // Load data for specific sections if needed
            if (sectionId === 'orders-section') {
                loadOrders(currentPage);
            } else if (sectionId === 'analytics-section') {
                loadStats(); // Ensure chart data is updated
            } else if (sectionId === 'newsletter-section') {
                loadSubscriberCount();
                loadNewsletterTemplates();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            quill = new Quill('#newsletterMessageEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['link'],
                        ['clean']
                    ]
                },
                placeholder: 'Enter your newsletter content here...',
                formats: [
                    'bold', 'italic', 'underline', 'list', 'bullet', 'link'
                ]
            });

            // Initialize with dashboard section visible
            showSection('dashboard-section');
            loadStats();
            initializeChart();
            startAutoRefresh();
        });

        async function loadStats() {
            try {
                const response = await fetch('http://localhost:6500/api/admin/stats');
                const data = await response.json();
                
                if (data.data) {
                    document.getElementById('totalOrders').textContent = data.data.totalOrders;
                    document.getElementById('totalRevenue').textContent = `₦${data.data.totalRevenue.toLocaleString()}`;
                    
                    let pendingCount = 0;
                    let deliveredCount = 0;
                    
                    data.data.statusBreakdown.forEach(status => {
                        if (status._id === 'pending') pendingCount = status.count;
                        if (status._id === 'delivered') deliveredCount = status.count;
                    });
                    
                    document.getElementById('pendingOrders').textContent = pendingCount;
                    document.getElementById('deliveredOrders').textContent = deliveredCount;
                    
                    updatePackageChart(data.data.packageBreakdown);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadOrders(page = 1) {
            const loading = document.getElementById('loading');
            const table = document.getElementById('ordersTable');
            const noData = document.getElementById('noData');
            
            loading.style.display = 'block';
            table.style.display = 'none';
            noData.style.display = 'none';
            
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: 10,
                    status: document.getElementById('statusFilter').value,
                    package: document.getElementById('packageFilter').value,
                    search: document.getElementById('searchInput').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value
                });
                
                const response = await fetch(`http://localhost:6500/api/admin/orders?${params}`);
                const data = await response.json();
                
                if (data.data && data.data.length > 0) {
                    displayOrders(data.data);
                    displayPagination(data.pagination);
                    document.getElementById('orderCount').textContent = `${data.pagination.totalOrders} orders`;
                    table.style.display = 'table';
                } else {
                    noData.style.display = 'block';
                    document.getElementById('orderCount').textContent = '0 orders';
                    document.getElementById('pagination').innerHTML = '';
                }
                
                currentPage = page;
            } catch (error) {
                console.error('Error loading orders:', error);
                noData.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        function displayOrders(orders) {
            const tbody = document.getElementById('ordersTableBody');
            tbody.innerHTML = '';
            
            orders.forEach(order => {
                const row = document.createElement('tr');
                
                let statusCell = '';
                if (order.status === 'pending') {
                    let processingStepsDisplay = '';
                    if (order.processingSteps && order.processingSteps.length > 0) {
                        const latestStep = order.processingSteps[order.processingSteps.length - 1];
                        processingStepsDisplay = `<div class="processing-steps">${latestStep.code}</div>`;
                    }
                
                    statusCell = `
                        <div class="status-container">
                            <span class="status-badge status-${order.status}" ondblclick="openProcessingStepsModal('${order._id}')" title="Double-click to manage processing steps">
                                ${order.status.toUpperCase()}
                            </span>
                            ${processingStepsDisplay}
                        </div>
                    `;
                } else {
                    statusCell = `<span class="status-badge status-${order.status}">${order.status.toUpperCase()}</span>`;
                }
                
                row.innerHTML = `
                    <td>${order.fullName}</td>
                    <td>${Array.isArray(order.phone) ? order.phone.join(', ') : order.phone}</td>
                    <td><span class="status-badge status-${order.package}">${order.package.toUpperCase()}</span></td>
                    <td>${order.address}, ${order.city}</td>
                    <td>${new Date(order.createdAt).toLocaleDateString()}</td>
                    <td class="status-cell">${statusCell}</td>
                    <td>
                        <button class="btn btn-secondary" onclick="viewOrderDetails('${order._id}')" style="margin-right: 5px;">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-primary" onclick="openStatusModal('${order._id}', '${order.status}')" style="margin-right: 5px;">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-success" onclick="openPackagePriceModal('${order._id}', '${order.package}', '${order.price}')" style="margin-right: 5px;">
                            <i class="fas fa-tag"></i>
                        </button>
                        <button class="btn btn-danger" onclick="deleteOrder('${order._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function displayPagination(pagination) {
            const paginationDiv = document.getElementById('pagination');
            paginationDiv.innerHTML = '';
            
            const prevBtn = document.createElement('button');
            prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i> Previous';
            prevBtn.disabled = !pagination.hasPrev;
            prevBtn.onclick = () => loadOrders(pagination.currentPage - 1);
            paginationDiv.appendChild(prevBtn);
            
            const startPage = Math.max(1, pagination.currentPage - 2);
            const endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.className = i === pagination.currentPage ? 'current' : '';
                pageBtn.onclick = () => loadOrders(i);
                paginationDiv.appendChild(pageBtn);
            }
            
            const nextBtn = document.createElement('button');
            nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
            nextBtn.disabled = !pagination.hasNext;
            nextBtn.onclick = () => loadOrders(pagination.currentPage + 1);
            paginationDiv.appendChild(nextBtn);
        }

        function applyFilters() {
            currentPage = 1;
            loadOrders(1);
        }

        async function viewOrderDetails(orderId) {
            try {
                const response = await fetch(`http://localhost:6500/api/admin/orders/${orderId}`);
                const data = await response.json();
                
                if (data.data) {
                    const order = data.data;
                    const detailsHtml = `
                        <div class="order-detail">
                            <div class="detail-item">
                                <strong>Full Name</strong>
                                ${order.fullName}
                            </div>
                            <div class="detail-item">
                                <strong>Phone Numbers</strong>
                                ${Array.isArray(order.phone) ? order.phone.join(', ') : order.phone}
                            </div>
                            <div class="detail-item">
                                <strong>WhatsApp Phone</strong>
                                ${order.whatsappPhone || 'Not provided'}
                            </div>
                            <div class="detail-item">
                                <strong>Package</strong>
                                ${order.package.toUpperCase()}
                            </div>
                            <div class="detail-item">
                                <strong>Address</strong>
                                ${order.address}
                            </div>
                            <div class="detail-item">
                                <strong>City</strong>
                                ${order.city}
                            </div>
                            <div class="detail-item">
                                <strong>State</strong>
                                ${order.state}
                            </div>
                            <div class="detail-item">
                                <strong>Price</strong>
                                ₦${order.price.toLocaleString()}
                            </div>
                            <div class="detail-item">
                                <strong>Availability</strong>
                                ${order.availability.toUpperCase()}
                            </div>
                            <div class="detail-item">
                                <strong>Status</strong>
                                <span class="status-badge status-${order.status}">${order.status.toUpperCase()}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Order Date</strong>
                                ${new Date(order.createdAt).toLocaleString()}
                            </div>
                            <div class="detail-item">
                                <strong>Last Updated</strong>
                                ${new Date(order.updatedAt).toLocaleString()}
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('orderDetails').innerHTML = detailsHtml;
                    document.getElementById('orderModal').style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading order details:', error);
                alert('Error loading order details');
            }
        }

        function openStatusModal(orderId, currentStatus) {
            currentOrderId = orderId;
            document.getElementById('newStatus').value = currentStatus;
            document.getElementById('statusModal').style.display = 'block';
        }

        async function updateOrderStatus() {
            if (!currentOrderId) return;
            try {
                const newStatus = document.getElementById('newStatus').value;
                const response = await fetch(`http://localhost:6500/api/admin/orders/${currentOrderId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    closeStatusModal();
                    loadOrders(currentPage);
                    loadStats();
                    
                    let alertMessage = 'Order status updated successfully!';
                    
                    if (result.notifications) {
                        const { sms, email } = result.notifications;
                        
                        if (sms.success) {
                            alertMessage += '\n✅ SMS notification sent to customer';
                        } else if (sms.message !== 'No SMS sent') {
                            alertMessage += '\n⚠️ SMS notification failed';
                        }
                        
                        if (email.success) {
                            alertMessage += '\n✅ Email notification sent to Admin';
                        } else if (email.message !== 'No email sent') {
                            alertMessage += '\n⚠️ Email notification failed';
                        }
                    }
                    
                    alert(alertMessage);
                } else {
                    alert('Error updating order status');
                }
            } catch (error) {
                console.error('Error updating status:', error);
                alert('Error updating order status');
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order?')) return;
            
            try {
                const response = await fetch(`http://localhost:6500/api/admin/orders/${orderId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadOrders(currentPage);
                    loadStats();
                    alert('Order deleted successfully!');
                } else {
                    alert('Error deleting order');
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Error deleting order');
            }
        }

        function initializeChart() {
            const ctx = document.getElementById('packageChart').getContext('2d');
            packageChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#667eea',
                            '#764ba2',
                            '#f093fb',
                            '#f5576c',
                            '#4facfe'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        function updatePackageChart(packageData) {
            if (!packageChart) return;
            
            const labels = [];
            const data = [];
            
            packageData.forEach(pkg => {
                labels.push(pkg._id.toUpperCase());
                data.push(pkg.count);
            });
            
            packageChart.data.labels = labels;
            packageChart.data.datasets[0].data = data;
            packageChart.update();
        }

        async function loadNewsletterTemplates() {
            try {
                const response = await fetch('http://localhost:6500/api/mail/templates');
                const data = await response.json();
                
                if (data.data) {
                    const templateSelector = document.getElementById('templateSelector');
                    templateSelector.innerHTML = '';
                    
                    data.data.forEach((template, index) => {
                        const templateDiv = document.createElement('div');
                        templateDiv.className = `template-option ${index === 0 ? 'selected' : ''}`;
                        templateDiv.onclick = () => selectTemplate(template.id, templateDiv);
                        templateDiv.innerHTML = `
                            <h4>${template.name}</h4>
                            <p>Click to select</p>
                        `;
                        templateSelector.appendChild(templateDiv);
                    });
                    
                    if (data.data.length > 0) {
                        selectedTemplate = data.data[0].id;
                    }
                }
            } catch (error) {
                console.error('Error loading templates:', error);
            }
        }

        function selectTemplate(templateId, element) {
            selectedTemplate = templateId;
            document.querySelectorAll('.template-option').forEach(option => {
                option.classList.remove('selected');
            });
            element.classList.add('selected');
        }

        function handleImageUrlInput(url) {
            const previewImage = document.getElementById('previewImage');
            const previewMessage = document.getElementById('previewMessage');
            const previewError = document.getElementById('previewError');

            previewImage.style.display = 'none';
            previewMessage.style.display = 'none';
            previewError.style.display = 'none';
            newsletterImage = null;

            if (!url) {
                console.log('handleImageUrlInput: No URL provided');
                return;
            }

            const urlPattern = /^(https?:\/\/[^\s/$.?#].[^\s]*\.(jpg|jpeg|png|gif))$/i;
            if (!urlPattern.test(url)) {
                previewError.style.display = 'block';
                console.log('handleImageUrlInput: Invalid image URL');
                return;
            }

            const img = new Image();
            img.onload = function() {
                newsletterImage = url;
                previewImage.src = url;
                previewImage.style.display = 'block';
                previewMessage.style.display = 'block';
                console.log('handleImageUrlInput: Image URL loaded successfully:', url);
            };
            img.onerror = function() {
                previewError.style.display = 'block';
                console.log('handleImageUrlInput: Failed to load image URL:', url);
            };
            img.src = url;
        }

        async function loadSubscriberCount() {
            try {
                const response = await fetch('http://localhost:6500/api/mail/subscribers');
                const data = await response.json();
                
                if (data.data) {
                    document.getElementById('subscriberCount').textContent = `${data.count} Subscribers`;
                }
            } catch (error) {
                console.error('Error loading subscriber count:', error);
            }
        }

        function toggleNewsletterSection() {
            const form = document.getElementById('newsletterForm');
            const list = document.getElementById('subscribersList');
            
            if (list.style.display === 'none') {
                form.style.display = 'none';
                list.style.display = 'block';
                loadSubscribers();
            } else {
                form.style.display = 'block';
                list.style.display = 'none';
            }
        }

        async function loadSubscribers() {
            try {
                const response = await fetch('http://localhost:6500/api/mail/subscribers');
                const data = await response.json();
                
                if (data.data) {
                    const tbody = document.getElementById('subscribersTableBody');
                    tbody.innerHTML = '';
                    
                    data.data.forEach(subscriber => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${subscriber.email}</td>
                            <td>${new Date(subscriber.subscribedAt).toLocaleDateString()}</td>
                            <td>
                                <button class="btn btn-danger" onclick="deleteSubscriber('${subscriber._id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error loading subscribers:', error);
            }
        }

        async function deleteSubscriber(subscriberId) {
            if (!confirm('Are you sure you want to delete this subscriber?')) return;
            
            try {
                const response = await fetch(`http://localhost:6500/api/mail/subscribers/${subscriberId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadSubscribers();
                    loadSubscriberCount();
                    alert('Subscriber deleted successfully!');
                } else {
                    alert('Error deleting subscriber');
                }
            } catch (error) {
                console.error('Error deleting subscriber:', error);
                alert('Error deleting subscriber');
            }
        }

        function refreshSubscribers() {
            loadSubscribers();
            loadSubscriberCount();
        }

        async function previewNewsletter() {
            const subject = document.getElementById('newsletterSubject').value;
            const message = quill.root.innerHTML;
            
            if (!subject || !message || message === '<p><br></p>') {
                alert('Please fill in subject and message');
                return;
            }

            const payload = JSON.stringify({
                subject,
                message,
                template: selectedTemplate,
                image: newsletterImage
            });
            console.log("Payload size:", new Blob([payload]).size / (1024 * 1024), "MB"); 

            try {
                const response = await fetch('http://localhost:6500/api/mail/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: payload
                });

                if (response.status === 413) {
                    alert("Request payload too large. Please use a smaller image or shorter message.");
                    return;
                }

                const data = await response.json();
                if (data.data) {
                    const previewFrame = document.getElementById('previewFrame');
                    previewFrame.srcdoc = data.data.html;
                    document.getElementById('previewModal').style.display = 'block';
                } else {
                    alert(`Error: ${data.message}`);
                }
            } catch (error) {
                console.error('Error previewing newsletter:', error);
                alert('Error previewing newsletter');
            }
        }

        async function sendNewsletter() {
            const subject = document.getElementById('newsletterSubject').value;
            const message = quill.root.innerHTML;
            if (!subject || !message || message === '<p><br></p>') {
                alert('Please fill in subject and message');
                return;
            }
            
            if (!confirm('Are you sure you want to send this newsletter to all subscribers?')) return;
            
            try {
                const response = await fetch('http://localhost:6500/api/mail/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        subject,
                        message,
                        template: selectedTemplate,
                        image: newsletterImage
                    })
                });
                
                const data = await response.json();
                if (response.ok) {
                    alert(`Newsletter sent successfully!\n\nSent to: ${data.data.successCount} subscribers\nFailed: ${data.data.failedCount} subscribers`);
                    
                    document.getElementById('newsletterSubject').value = '';
                    quill.root.innerHTML = '';
                    newsletterImage = null;
                    document.getElementById('newsletterImageUrl').value = '';
                    document.getElementById('previewImage').style.display = 'none';
                    document.getElementById('previewMessage').style.display = 'none';
                    document.getElementById('previewError').style.display = 'none';
                } else {
                    alert(`Error sending newsletter: ${data.message}`);
                }
            } catch (error) {
                console.error('Error sending newsletter:', error);
                alert('Error sending newsletter');
            }
        }

        async function exportToExcel() {
            try {
                const response = await fetch('http://localhost:6500/api/admin/export/excel');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'orders.xlsx';
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('Error exporting to Excel');
            }
        }

        async function exportToPDF() {
            try {
                const response = await fetch('http://localhost:6500/api/admin/export/pdf');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'orders.pdf';
                a.click();
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting to PDF:', error);
                alert('Error exporting to PDF');
            }
        }

        let currentPackagePriceOrderId = null;

        function openPackagePriceModal(orderId, currentPackage, currentPrice) {
            currentPackagePriceOrderId = orderId;
            document.getElementById('newPackage').value = currentPackage;
            document.getElementById('newPrice').value = currentPrice;
            document.getElementById('packagePriceModal').style.display = 'block';
            stopAutoRefresh();
        }

        function closePackagePriceModal() {
            document.getElementById('packagePriceModal').style.display = 'none';
            currentPackagePriceOrderId = null;
            startAutoRefresh();
        }

        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
            startAutoRefresh();
        }

        async function updatePackagePrice() {
            if (!currentPackagePriceOrderId) return;
            
            const newPackage = document.getElementById('newPackage').value.trim();
            const newPrice = document.getElementById('newPrice').value;
            
            if (!newPackage) {
                alert('Please enter a package name');
                return;
            }
            
            if (!newPrice || newPrice <= 0) {
                alert('Please enter a valid price');
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:6500/api/admin/orders/${currentPackagePriceOrderId}/package-price`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        package: newPackage, 
                        price: parseFloat(newPrice) 
                    })
                });
                
                if (response.ok) {
                    closePackagePriceModal();
                    loadOrders(currentPage);
                    loadStats();
                    alert('Package and price updated successfully!');
                } else {
                    const errorData = await response.json();
                    alert(`Error updating package/price: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Error updating package/price:', error);
                alert('Error updating package and price');
            }
        }

        let currentProcessingOrderId = null;
        let selectedProcessingCode = null;

        const processingCodes = {
            'N.A': 'Not Available',
            'N.P': 'Not Picking',
            'N.R': 'Not reachable',
            'N.B': 'Number Busy',
            'S.O': 'Switch Off',
            'I.N': 'Incorrect Number',
            'N.L.B': 'No longer Buying',
        };

        function openProcessingStepsModal(orderId) {
            currentProcessingOrderId = orderId;
            selectedProcessingCode = null;
            document.getElementById('processingStepsModal').style.display = 'block';
            stopAutoRefresh();
            loadProcessingSteps(orderId);
            renderProcessingCodes();
        }

        function closeProcessingStepsModal() {
            document.getElementById('processingStepsModal').style.display = 'none';
            setTimeout(() => {
                currentProcessingOrderId = null;
                selectedProcessingCode = null;
            }, 100);
            startAutoRefresh();
        }

        async function loadProcessingSteps(orderId) {
            try {
                const response = await fetch(`http://localhost:6500/api/admin/orders/${orderId}/processing-steps`);
                const data = await response.json();
                
                if (data.data) {
                    displayProcessingSteps(data.data.processingSteps);
                }
            } catch (error) {
                console.error('Error loading processing steps:', error);
            }
        }

        function displayProcessingSteps(steps) {
            const stepsList = document.getElementById('stepsList');
            
            if (!steps || steps.length === 0) {
                stepsList.innerHTML = '<p style="color: #666; font-style: italic;">No processing steps yet</p>';
                return;
            }
            
            stepsList.innerHTML = '';
            steps.forEach(step => {
                const stepDiv = document.createElement('div');
                stepDiv.className = 'processing-step-item';
                stepDiv.innerHTML = `
                    <strong>Process ${step.step}: ${step.code}</strong>
                    <span>${step.description} - ${new Date(step.createdAt).toLocaleString()}</span>
                `;
                stepsList.appendChild(stepDiv);
            });
        }

        function renderProcessingCodes() {
            const codesContainer = document.getElementById('processingCodes');
            codesContainer.innerHTML = '';
            
            Object.keys(processingCodes).forEach(code => {
                const codeDiv = document.createElement('div');
                codeDiv.className = 'code-option';
                codeDiv.onclick = () => selectProcessingCode(code, codeDiv);
                codeDiv.innerHTML = `
                    <span class="code">${code}</span>
                    <span class="desc">${processingCodes[code]}</span>
                `;
                codesContainer.appendChild(codeDiv);
            });
        }

        function selectProcessingCode(code, element) {
            selectedProcessingCode = code;
            
            document.querySelectorAll('.code-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            element.classList.add('selected');
            
            document.getElementById('addStepBtn').disabled = false;
        }

        async function addProcessingStep() {
            if (!currentProcessingOrderId || !selectedProcessingCode) {
                alert('Please select a processing code');
                return;
            }
            
            const codeToAdd = selectedProcessingCode;
            
            try {
                const response = await fetch(`http://localhost:6500/api/admin/orders/${currentProcessingOrderId}/processing-step`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        code: codeToAdd
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`Processing step "${codeToAdd}" added successfully!`);
                    closeProcessingStepsModal();
                    loadOrders(currentPage);
                } else {
                    const errorData = await response.json();
                    alert(`Error adding processing step: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Error adding processing step:', error);
                alert('Error adding processing step');
            }
        }

        function closeStatusModal() {
            document.getElementById('statusModal').style.display = 'none';
            currentOrderId = null;
            startAutoRefresh();
        }

        function closePreviewModal() {
            document.getElementById('previewModal').style.display = 'none';
            startAutoRefresh();
        }

        window.onclick = function(event) {
            const orderModal = document.getElementById('orderModal');
            const statusModal = document.getElementById('statusModal');
            const previewModal = document.getElementById('previewModal');
            const packagePriceModal = document.getElementById('packagePriceModal');
            const processingStepsModal = document.getElementById('processingStepsModal');
            
            if (event.target === orderModal) {
                closeModal();
            }
            if (event.target === statusModal) {
                closeStatusModal();
            }
            if (event.target === previewModal) {
                closePreviewModal();
            }
            if (event.target === packagePriceModal) {
                closePackagePriceModal();
            }
            if (event.target === processingStepsModal) {
                closeProcessingStepsModal();
            }
        }

        document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 500));
        document.getElementById('statusFilter').addEventListener('change', applyFilters);
        document.getElementById('packageFilter').addEventListener('change', applyFilters);
        document.getElementById('startDate').addEventListener('change', applyFilters);
        document.getElementById('endDate').addEventListener('change', applyFilters);

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        document.getElementById('newsletterSubject').addEventListener('focus', stopAutoRefresh);
        document.getElementById('newsletterImageUrl').addEventListener('focus', stopAutoRefresh);
        document.getElementById('newsletterMessageEditor').addEventListener('focus', stopAutoRefresh);

        document.getElementById('newsletterSubject').addEventListener('blur', startAutoRefresh);
        document.getElementById('newsletterImageUrl').addEventListener('blur', startAutoRefresh);
        document.getElementById('newsletterMessageEditor').addEventListener('blur', startAutoRefresh);
    </script>
</body>
</html>